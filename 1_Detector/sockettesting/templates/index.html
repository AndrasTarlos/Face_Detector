<!DOCTYPE html>
<html lang="en">

<head>
    <title>Face Detector</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src='https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-camera-enhancer@2.3.1/dist/dce.js"></script>
</head>

<body>
    <div id="enhancerUIContainer" style="width:100%;height:100vh;">
        <div class="dce-video-container" style="position:relative;width:100%"></div>
    </div>

    <div class="controller">
        <button id="on_off">Off</button>
    </div>

    <script type="text/javascript" charset="utf-8">
        var socket = io.connect("http://127.0.0.1:5000");
        socket.on('connect', function(){
            console.log("Connection established")
        });

        navigator.mediaDevices.getUserMedia({video: true});
        let enhancer;
        (async () => {
            enhancer = await Dynamsoft.DCE.CameraEnhancer.createInstance();
            document.getElementById("enhancerUIContainer").appendChild(enhancer.getUIElement());
            await enhancer.open(true);
            await getFrames()
        })();

        /*
        console.log(typeof img)
        var reader = new FileReader();
        reader.onload = function () {
            const base64 = img.result.replace("data:", "").replace(/^.+,/, "");
            console.log(base64)
        }

         */


        const on_off = document.getElementById("on_off");

        /*
        socket.on('my response', name, function(msg) {
            console.log(msg.data);
        });

         */
            async function getFrames() {
                setInterval(() => {
                    const uint8Data= enhancer.getFrame().data;
                    var b64encoded = btoa(String.fromCharCode.apply(null, uint16Data))
                    console.log(b64encoded)

                        //socket.emit("frame", uint8Data.toString())
                }, 2000);
            }

        let timer = null, interval = 2000;

        on_off.addEventListener("click", function() {
            if (on_off.innerHTML === "Off") {
                on_off.innerHTML = "On"
                if (timer !== null) return;
                    timer = setInterval(function() {
                        // TODO Send frame
                    }, interval);
                } else {
                    on_off.innerHTML = "Off"
                    clearInterval(timer);
                    timer = null
                }
            }
        );
    </script>
</body>

</html>